<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3498db">
    <title>è‰²å·®æ£€æŸ¥å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'HarmonyOS Sans', 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary-color: #2563eb;
            --primary-light: #60a5fa;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark-color: #1e293b;
            --medium-color: #64748b;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            flex-grow: 1;
        }

        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        h1 {
            color: white;
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.05rem;
            font-weight: 400;
        }
        
        .harmony-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .card {
            background-color: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            padding: 28px;
            margin-bottom: 24px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.4rem;
            color: var(--dark-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            background-color: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 16/9;
        }
        
        .image-thumbnail {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 16px;
            max-height: 500px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .camera-placeholder {
            text-align: center;
            color: white;
            padding: 20px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            min-width: 160px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-capture {
            background: linear-gradient(135deg, var(--danger-color) 0%, #f87171 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #34d399 100%);
        }

        .btn-upload {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }

        .btn-reset {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
        }
        
        .color-selection-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .color-preview {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            margin-right: 18px;
            border: 4px solid white;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .color-preview:hover {
            transform: scale(1.05);
        }
        
        .color-info {
            flex-grow: 1;
        }
        
        .color-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .comparison-result {
            padding: 0;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .result-item {
            background: linear-gradient(135deg, var(--light-color) 0%, white 100%);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .result-item.delta-e {
            background: linear-gradient(135deg, #dbeafe 0%, white 100%);
        }

        .result-item.grade {
            background: linear-gradient(135deg, #dcfce7 0%, white 100%);
        }

        .result-label {
            font-size: 0.95rem;
            color: var(--medium-color);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-color);
        }

        .result-detail {
            background-color: var(--light-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
        }

        .result-description {
            font-size: 1.1rem;
            color: var(--dark-color);
            font-weight: 500;
            margin-top: 6px;
        }

        .result-direction {
            font-size: 1.1rem;
            color: var(--medium-color);
            font-weight: 500;
            margin-top: 6px;
        }

        .footer {
            text-align: center;
            padding: 30px 20px;
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.9rem;
        }

        .footer a {
            color: white;
            text-decoration: underline;
            transition: all 0.3s ease;
        }

        .footer a:hover {
            color: #bfdbfe;
            text-decoration: none;
        }

        .status {
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-success {
            background-color: rgba(16, 185, 129, 0.15);
            color: #059669;
            border-left: 4px solid #10b981;
        }

        .status-warning {
            background-color: rgba(245, 158, 11, 0.15);
            color: #d97706;
            border-left: 4px solid #f59e0b;
        }

        .status-error {
            background-color: rgba(239, 68, 68, 0.15);
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }

        .status-info {
            background-color: rgba(37, 99, 235, 0.15);
            color: #1d4ed8;
            border-left: 4px solid #2563eb;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .image-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .marker {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(52, 152, 219, 0.9);
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }
        
        .marker-2 {
            background-color: rgba(231, 76, 60, 0.9);
        }
        
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“· è‰²å·®æ£€æŸ¥å™¨</h1>
            <p class="subtitle">é€šè¿‡ä¸Šä¼ å›¾ç‰‡è¿›è¡Œé¢œè‰²å¯¹æ¯”</p>
        </header>
        
        <div class="card">
            <h2 class="card-title">ğŸ“· å›¾åƒè·å–</h2>

            <div class="status status-info">
                â„¹ è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ (JPG, PNG, WebP)
            </div>
            <div class="camera-container" id="uploadContainer">
                <div class="image-wrapper" id="uploadImageWrapper" style="display:none;">
                    <img class="image-thumbnail" id="uploadImageDisplay">
                    <div class="image-overlay" id="uploadImageOverlay"></div>
                </div>
                <div class="camera-placeholder" id="uploadPlaceholder">
                    <div style="font-size:4rem;margin-bottom:20px;">ğŸ“¤</div>
                    <p>ç­‰å¾…å›¾ç‰‡ä¸Šä¼ </p>
                    <p>æ”¯æŒ JPGã€PNG æ ¼å¼</p>
                </div>
            </div>

            <div class="controls">
                <div class="file-input-wrapper">
                    <button class="btn btn-upload" id="uploadBtn">ğŸ“¤ é€‰æ‹©å›¾ç‰‡</button>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <button class="btn btn-reset" id="resetUpload" disabled>â†» é‡æ–°é€‰æ‹©</button>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title">ğŸ¨ é¢œè‰²é€‰æ‹©</h2>
            <p>ç‚¹å‡»ç…§ç‰‡é€‰æ‹©ä¸¤ç§é¢œè‰²è¿›è¡Œå¯¹æ¯”ï¼š</p>
            
            <div class="color-selection-area">
                <div class="color-picker">
                    <div class="color-preview" id="color1Preview" style="background-color: #3498db;"></div>
                    <div class="color-info">
                        <div class="color-name">é¢œè‰² 1 <span id="color1Marker" style="display:none;">(â‘ )</span></div>
                        <div id="color1Hex">#3498DB</div>
                        <div id="color1RGB">RGB(52, 152, 219)</div>
                    </div>
                </div>
                
                <div class="color-picker">
                    <div class="color-preview" id="color2Preview" style="background-color: #e74c3c;"></div>
                    <div class="color-info">
                        <div class="color-name">é¢œè‰² 2 <span id="color2Marker" style="display:none;">(â‘¡)</span></div>
                        <div id="color2Hex">#E74C3C</div>
                        <div id="color2RGB">RGB(231, 76, 60)</div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-success" id="compareColors" disabled>âš– å¯¹æ¯”é¢œè‰²</button>
                <button class="btn btn-reset" id="resetColors">âœ é‡ç½®é¢œè‰²</button>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title">ğŸ“Š è‰²å·®å¯¹æ¯”ç»“æœ</h2>
            <div class="comparison-result">
                <div class="result-grid">
                    <div class="result-item delta-e">
                        <div class="result-label">Î”E å€¼</div>
                        <div class="result-value" id="differenceValue">0.0</div>
                    </div>
                    <div class="result-item grade">
                        <div class="result-label">ç­‰çº§è¯„å®š</div>
                        <div class="result-value" id="gradeValue">-</div>
                    </div>
                </div>
                <div class="result-detail">
                    <div class="result-label">è‰²å·®æè¿°</div>
                    <div class="result-description" id="differenceText">æœªå¼€å§‹å¯¹æ¯”</div>
                </div>
                <div class="result-detail">
                    <div class="result-label">è‰²å·®æ–¹å‘</div>
                    <div class="result-direction" id="directionText">-</div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Â© 2025 æœ±ä¸€ä¸œ | å¦‚æœ‰å»ºè®®è¯·å‘é€è‡³ <a href="mailto:328117421@qq.com">328117421@qq.com</a></p>
        </footer>
    </div>

    <script>
        // ç®€å•ç›´æ¥çš„å®ç° - é¿å…å¤æ‚çš„äº‹ä»¶å§”æ‰˜
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–åº”ç”¨...');
            
            // åº”ç”¨çŠ¶æ€
            const app = {
                imageLoaded: false,
                selectedColor1: { r: 52, g: 152, b: 219 },
                selectedColor2: { r: 231, g: 76, b: 60 },
                color1Pixels: [], // é¢œè‰²1é‡‡æ ·åŒºåŸŸçš„æ‰€æœ‰åƒç´ 
                color2Pixels: [], // é¢œè‰²2é‡‡æ ·åŒºåŸŸçš„æ‰€æœ‰åƒç´ 
                colorSelectionStep: 0, // 0: æœªé€‰æ‹©, 1: å·²é€‰ç¬¬ä¸€ä¸ª, 2: å·²é€‰ç¬¬äºŒä¸ª
                markers: []
            };
            
            // DOMå…ƒç´ 
            const elements = {
                resetUploadBtn: document.getElementById('resetUpload'),
                compareColorsBtn: document.getElementById('compareColors'),
                resetColorsBtn: document.getElementById('resetColors'),
                fileInput: document.getElementById('fileInput'),
                uploadBtn: document.getElementById('uploadBtn')
            };

            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            elements.compareColorsBtn.disabled = true;
            elements.resetUploadBtn.disabled = true;
            
            // ä¸Šä¼ å›¾ç‰‡
            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageDisplay = document.getElementById('uploadImageDisplay');
                    const imageWrapper = document.getElementById('uploadImageWrapper');
                    
                    // åˆ›å»ºå›¾ç‰‡æ¥è·å–å°ºå¯¸
                    const img = new Image();
                    img.onload = function() {
                        // åˆ›å»ºcanvasç¼©æ”¾å›¾ç‰‡
                        const canvas = document.createElement('canvas');
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        // è®¡ç®—ç¼©æ”¾
                        if (width > height && width > maxSize) {
                            height = (maxSize / width) * height;
                            width = maxSize;
                        } else if (height > maxSize) {
                            width = (maxSize / height) * width;
                            height = maxSize;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // æ˜¾ç¤ºç¼©æ”¾åçš„å›¾ç‰‡
                        imageDisplay.src = canvas.toDataURL('image/jpeg', 0.9);
                        imageWrapper.style.display = 'block';
                        document.getElementById('uploadPlaceholder').style.display = 'none';
                        
                        app.imageLoaded = true;
                        elements.compareColorsBtn.disabled = false;
                        elements.resetUploadBtn.disabled = false;
                        app.colorSelectionStep = 0;
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // é‡ç½®ä¸Šä¼ 
            function resetUpload() {
                elements.fileInput.value = '';
                document.getElementById('uploadImageWrapper').style.display = 'none';
                document.getElementById('uploadPlaceholder').style.display = 'flex';
                app.imageLoaded = false;
                elements.compareColorsBtn.disabled = true;
                elements.resetUploadBtn.disabled = true;
                resetColorSelection();
            }
            
            // å›¾ç‰‡ç‚¹å‡»é€‰æ‹©é¢œè‰²
            function setupImageClickListeners() {
                const container = document.getElementById('uploadContainer');
                if (container) {
                    container.addEventListener('click', function(e) {
                        if (!app.imageLoaded) return;

                        if (e.target.classList.contains('image-thumbnail')) {
                            handleImageClick(e, 'uploadContainer');
                        }
                    });
                }
            }
            
            // å¤„ç†å›¾ç‰‡ç‚¹å‡»
            function handleImageClick(e, containerId) {
                try {
                    const container = document.getElementById(containerId);
                    const img = document.querySelector('#' + containerId + ' .image-thumbnail');

                    if (!img) return;

                    // è·å–ç‚¹å‡»ä½ç½®ï¼ˆç›¸å¯¹äºå›¾ç‰‡å…ƒç´ ï¼‰
                    const rect = img.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆå›¾ç‰‡å†…éƒ¨åƒç´  / æ˜¾ç¤ºåƒç´ ï¼‰
                    const scaleX = (img.naturalWidth || img.width) / rect.width;
                    const scaleY = (img.naturalHeight || img.height) / rect.height;

                    // è½¬æ¢ä¸ºå›¾ç‰‡å†…éƒ¨çš„åƒç´ åæ ‡
                    const imgX = Math.floor(x * scaleX);
                    const imgY = Math.floor(y * scaleY);

                    // åˆ›å»ºcanvasè·å–é¢œè‰²
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = img.naturalWidth || img.width;
                    tempCanvas.height = img.naturalHeight || img.height;
                    const ctx = tempCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    // è·å–å‘¨è¾¹åŒºåŸŸçš„æ‰€æœ‰åƒç´ 
                    const sampleSize = 10; // é‡‡æ ·åŒºåŸŸå¤§å° (10x10 = 100åƒç´ )
                    const halfSize = Math.floor(sampleSize / 2);

                    // ç¡®ä¿é‡‡æ ·åŒºåŸŸåœ¨å›¾ç‰‡èŒƒå›´å†…
                    const startX = Math.max(0, imgX - halfSize);
                    const startY = Math.max(0, imgY - halfSize);
                    const endX = Math.min(tempCanvas.width - 1, imgX + halfSize);
                    const endY = Math.min(tempCanvas.height - 1, imgY + halfSize);

                    // æ”¶é›†æ‰€æœ‰åƒç´ æ•°æ®
                    const pixels = [];
                    let rTotal = 0, gTotal = 0, bTotal = 0, count = 0;

                    for (let i = startX; i <= endX; i++) {
                        for (let j = startY; j <= endY; j++) {
                            const pixel = ctx.getImageData(i, j, 1, 1).data;
                            const pixelColor = { r: pixel[0], g: pixel[1], b: pixel[2] };
                            pixels.push(pixelColor);
                            rTotal += pixel[0];
                            gTotal += pixel[1];
                            bTotal += pixel[2];
                            count++;
                        }
                    }

                    // è®¡ç®—å¹³å‡é¢œè‰²ç”¨äºæ˜¾ç¤º
                    const color = {
                        r: Math.round(rTotal / count),
                        g: Math.round(gTotal / count),
                        b: Math.round(bTotal / count)
                    };

                    // é€‰æ‹©é¢œè‰²ï¼ˆä¼ é€’åƒç´ æ•°æ®ï¼‰
                    selectColor(color, x, y, containerId, pixels);

                } catch (err) {
                    console.error('é€‰æ‹©é¢œè‰²é”™è¯¯:', err);
                }
            }
            
            // é€‰æ‹©é¢œè‰²
            function selectColor(color, x, y, containerId, pixels = null) {
                const overlayId = 'uploadImageOverlay';

                if (app.colorSelectionStep === 0) {
                    // é€‰æ‹©ç¬¬ä¸€ä¸ªé¢œè‰²
                    app.selectedColor1 = color;
                    app.color1Pixels = pixels; // ä¿å­˜åƒç´ æ•°æ®
                    updateColorDisplay(1, color);
                    app.colorSelectionStep = 1;
                    addMarker(x, y, 1, overlayId);

                } else if (app.colorSelectionStep === 1) {
                    // é€‰æ‹©ç¬¬äºŒä¸ªé¢œè‰²
                    app.selectedColor2 = color;
                    app.color2Pixels = pixels; // ä¿å­˜åƒç´ æ•°æ®
                    updateColorDisplay(2, color);
                    app.colorSelectionStep = 2;
                    addMarker(x, y, 2, overlayId);
                }
            }
            
            // æ·»åŠ æ ‡è®°
            function addMarker(x, y, number, overlayId) {
                const overlay = document.getElementById(overlayId);
                if (!overlay) return;
                
                // åˆ›å»ºæ ‡è®°
                const marker = document.createElement('div');
                marker.className = 'marker marker-' + number;
                marker.textContent = number === 1 ? 'â‘ ' : 'â‘¡';
                marker.style.left = x + 'px';
                marker.style.top = y + 'px';
                
                overlay.appendChild(marker);
                app.markers.push(marker);
                
                // æ˜¾ç¤ºé¢œè‰²ç¼–å·
                document.getElementById('color' + number + 'Marker').style.display = 'inline';
            }
            
            // æ¸…é™¤æ ‡è®°
            function clearMarkers() {
                app.markers.forEach(marker => {
                    if (marker.parentNode) {
                        marker.parentNode.removeChild(marker);
                    }
                });
                app.markers = [];
                
                document.getElementById('color1Marker').style.display = 'none';
                document.getElementById('color2Marker').style.display = 'none';
            }
            
            // æ›´æ–°é¢œè‰²æ˜¾ç¤º
            function updateColorDisplay(num, color) {
                const hex = rgbToHex(color.r, color.g, color.b);
                const rgb = `RGB(${color.r}, ${color.g}, ${color.b})`;
                
                document.getElementById('color' + num + 'Preview').style.backgroundColor = hex;
                document.getElementById('color' + num + 'Hex').textContent = hex;
                document.getElementById('color' + num + 'RGB').textContent = rgb;
            }
            
            // RGBè½¬åå…­è¿›åˆ¶
            function rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
            }
            
            // å¯¹æ¯”é¢œè‰²
            function compareColors() {
                try {
                    // è®¡ç®—è‰²å·®ï¼ˆæ‰¾å‡ºå¤šå¯¹æœ€æ¥è¿‘çš„åƒç´ å¯¹çš„å¹³å‡å€¼ï¼‰
                    const result = findClosestPixelPairs(app.color1Pixels, app.color2Pixels);
                    const deltaE = result.avgDistance;

                    // æ ¹æ®GB/T 250æ ‡å‡†è®¡ç®—ç­‰çº§
                    const gradeInfo = calculateColorGrade(deltaE);

                    // åˆ†æè‰²å·®æ–¹å‘
                    const directionAnalysis = analyzeColorDifference(app.selectedColor1, app.selectedColor2);

                    // æ˜¾ç¤ºÎ”Eå€¼
                    document.getElementById('differenceValue').textContent = deltaE.toFixed(2);

                    // æ˜¾ç¤ºç­‰çº§
                    document.getElementById('gradeValue').textContent = gradeInfo.grade;

                    // æ˜¾ç¤ºæè¿°
                    document.getElementById('differenceText').textContent = gradeInfo.description;

                    // æ˜¾ç¤ºè‰²å·®æ–¹å‘
                    if (directionAnalysis.length > 0) {
                        document.getElementById('directionText').textContent =
                            'é¢œè‰²â‘¡æ¯”é¢œè‰²â‘ ' + directionAnalysis.join('ã€');
                    } else {
                        document.getElementById('directionText').textContent = 'æ— æ˜æ˜¾åè‰²';
                    }

                } catch (err) {
                    document.getElementById('differenceValue').textContent = 'é”™è¯¯';
                    document.getElementById('gradeValue').textContent = 'é”™è¯¯';
                    document.getElementById('differenceText').textContent = 'è®¡ç®—å¤±è´¥';
                    document.getElementById('directionText').textContent = '-';
                }
            }

            // æ‰¾å‡ºä¸¤ä¸ªé¢œè‰²åŒºåŸŸä¸­æœ€æ¥è¿‘çš„å¤šå¯¹åƒç´ å¯¹ï¼Œå¹¶è®¡ç®—å¹³å‡è·ç¦»
            function findClosestPixelPairs(pixels1, pixels2, topN = 20) {
                // å­˜å‚¨æ‰€æœ‰åƒç´ å¯¹çš„è·ç¦»
                const allDistances = [];

                // éå†æ‰€æœ‰åƒç´ å¯¹ï¼Œè®¡ç®—è·ç¦»
                for (const p1 of pixels1) {
                    for (const p2 of pixels2) {
                        const distance = calculateColorDifference(p1, p2);
                        allDistances.push({ distance, p1, p2 });
                    }
                }

                // æŒ‰è·ç¦»å‡åºæ’åº
                allDistances.sort((a, b) => a.distance - b.distance);

                // å–å‰Nä¸ªæœ€æ¥è¿‘çš„åƒç´ å¯¹
                const count = Math.min(topN, allDistances.length);
                const topPairs = allDistances.slice(0, count);

                // è®¡ç®—è¿™äº›åƒç´ å¯¹çš„å¹³å‡è·ç¦»
                const totalDistance = topPairs.reduce((sum, item) => sum + item.distance, 0);
                const avgDistance = totalDistance / count;

                return { avgDistance, topPairs };
            }
            
            // è®¡ç®—è‰²å·®å€¼ï¼ˆä½¿ç”¨ CIE1976 Lab å…¬å¼ç®€åŒ–ç‰ˆï¼Œå³æ¬§æ°è·ç¦»ï¼‰
            function calculateColorDifference(color1, color2) {
                const rDiff = color1.r - color2.r;
                const gDiff = color1.g - color2.g;
                const bDiff = color1.b - color2.b;
                return Math.sqrt(rDiff * rDiff + gDiff * gDiff + bDiff * bDiff);
            }

            // åˆ†æè‰²å·®æ–¹å‘
            function analyzeColorDifference(color1, color2) {
                const rDiff = color1.r - color2.r;
                const gDiff = color1.g - color2.g;
                const bDiff = color1.b - color2.b;

                // è®¡ç®—äº®åº¦å·®å¼‚
                const brightness1 = (color1.r * 299 + color1.g * 587 + color1.b * 114) / 1000;
                const brightness2 = (color2.r * 299 + color2.g * 587 + color2.b * 114) / 1000;
                const brightnessDiff = brightness1 - brightness2;

                const analysis = [];

                // çº¢è‰²/ç»¿è‰²å·®å¼‚
                if (Math.abs(rDiff) > 15) {
                    analysis.push(rDiff > 0 ? 'åçº¢' : 'åç»¿');
                }

                // è“è‰²/é»„è‰²å·®å¼‚
                if (Math.abs(bDiff) > 15) {
                    analysis.push(bDiff > 0 ? 'åè“' : 'åé»„');
                }

                // äº®åº¦å·®å¼‚
                if (Math.abs(brightnessDiff) > 20) {
                    analysis.push(brightnessDiff > 0 ? 'åäº®' : 'åæš—');
                }

                return analysis;
            }

            // è®¡ç®—è‰²å·®ç­‰çº§ï¼ˆGB/T 250æ ‡å‡†ï¼‰
            function calculateColorGrade(deltaE) {
                if (deltaE < 0.4) return { grade: '5çº§', description: 'æ— è‰²å·®', type: 'success' };
                if (deltaE < 1.25) return { grade: '4-5çº§', description: 'æå°è‰²å·®', type: 'success' };
                if (deltaE < 2.1) return { grade: '4çº§', description: 'å¾®å°è‰²å·®', type: 'success' };
                if (deltaE < 2.95) return { grade: '3-4çº§', description: 'è½»åº¦è‰²å·®', type: 'warning' };
                if (deltaE < 4.1) return { grade: '3çº§', description: 'å¯å¯Ÿè§‰è‰²å·®', type: 'warning' };
                if (deltaE < 5.8) return { grade: '2-3çº§', description: 'æ˜æ˜¾è‰²å·®', type: 'warning' };
                if (deltaE < 8.2) return { grade: '2çº§', description: 'è¾ƒå¤§è‰²å·®', type: 'error' };
                if (deltaE < 11.6) return { grade: '1-2çº§', description: 'å¾ˆå¤§è‰²å·®', type: 'error' };
                return { grade: '1çº§', description: 'æå¤§è‰²å·®', type: 'error' };
            }
            
            // é‡ç½®é¢œè‰²é€‰æ‹©
            function resetColorSelection() {
                app.selectedColor1 = { r: 52, g: 152, b: 219 };
                app.selectedColor2 = { r: 231, g: 76, b: 60 };
                app.color1Pixels = [];
                app.color2Pixels = [];
                app.colorSelectionStep = 0;

                updateColorDisplay(1, app.selectedColor1);
                updateColorDisplay(2, app.selectedColor2);

                clearMarkers();

                document.getElementById('differenceValue').textContent = '0.0';
                document.getElementById('differenceText').textContent = 'æœªå¼€å§‹å¯¹æ¯”';
                document.getElementById('differenceText').className = 'status';
            }
            
            // ç¿»è½¬æ‘„åƒå¤´
            function flipCamera() {
                if (app.stream) {
                    app.stream.getTracks().forEach(track => track.stop());
                    app.stream = null;
                }
                
                app.currentCamera = app.currentCamera === 'environment' ? 'user' : 'environment';
                startCamera();
            }
            
            // ç»‘å®šäº‹ä»¶
            function bindEvents() {
                // ä¸Šä¼ æŒ‰é’®
                elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
                elements.fileInput.addEventListener('change', handleFileUpload);
                elements.resetUploadBtn.addEventListener('click', resetUpload);

                // é¢œè‰²æŒ‰é’®
                elements.compareColorsBtn.addEventListener('click', compareColors);
                elements.resetColorsBtn.addEventListener('click', resetColorSelection);

                // å›¾ç‰‡ç‚¹å‡»
                setupImageClickListeners();
            }

            // åˆå§‹åŒ–
            function init() {
                console.log('åˆå§‹åŒ–åº”ç”¨');
                bindEvents();
                resetColorSelection();
            }
            
            // å¯åŠ¨åº”ç”¨
            init();
            
        });
    </script>
</body>
</html>